/*! For license information please see 4141.e9e58954.iframe.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunkpassbolt_styleguide=self.webpackChunkpassbolt_styleguide||[]).push([[4141],{"./src/react-extension/components/SecretHistory/DisplayResourceSecretHistory.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>DisplayResourceSecretHistory});var react=__webpack_require__("./node_modules/react/index.js"),es=__webpack_require__("./node_modules/react-i18next/dist/es/index.js"),prop_types=__webpack_require__("./node_modules/prop-types/index.js"),prop_types_default=__webpack_require__.n(prop_types),DialogWrapper=__webpack_require__("./src/react-extension/components/Common/Dialog/DialogWrapper/DialogWrapper.js"),FormSubmitButton=__webpack_require__("./src/react-extension/components/Common/Inputs/FormSubmitButton/FormSubmitButton.js"),AppContext=__webpack_require__("./src/shared/context/AppContext/AppContext.js"),TooltipPortal=__webpack_require__("./src/react-extension/components/Common/Tooltip/TooltipPortal.js"),assertString=__webpack_require__("./node_modules/validator/es/lib/util/assertString.js"),entityV2Collection=__webpack_require__("./src/shared/models/entity/abstract/entityV2Collection.js"),entityV2=__webpack_require__("./src/shared/models/entity/abstract/entityV2.js"),entitySchema=__webpack_require__("./src/shared/models/entity/abstract/entitySchema.js"),entityValidationError=__webpack_require__("./src/shared/models/entity/abstract/entityValidationError.js"),secretDataEntity=__webpack_require__("./src/shared/models/entity/secretData/secretDataEntity.js");class SecretEntity extends entityV2.A{constructor(dto,options={}){super(dto,options)}static getSchema(){return{type:"object",required:["data"],properties:{id:{type:"string",format:"uuid"},user_id:{type:"string",format:"uuid"},resource_id:{type:"string",format:"uuid"},secret_revision_id:{type:"string",format:"uuid",nullable:!0},data:{type:"string"},created:{type:"string",format:"date-time"},created_by:{type:"string",format:"uuid",nullable:!0},modified:{type:"string",format:"date-time"},modified_by:{type:"string",format:"uuid",nullable:!0}}}}validateBuildRules(){SecretEntity.assertValidMessage(this._props.data)}get id(){return this._props.id||null}get data(){return this.isDataDecrypted?this._data:this._props.data}get userId(){return this._props.user_id||null}get resourceId(){return this._props.resource_id||null}get secretRevisionId(){return this._props.secret_revision_id||null}get isDataDecrypted(){return Boolean(this._data)}set data(data){if("string"==typeof data)entitySchema.A.validateProp("data",data,this.cachedSchema.properties.data),this._props.data=data,delete this._data;else{if(!(data instanceof secretDataEntity.A))throw new TypeError("The given data is not of type SecretDataEntity");this._data=new data.constructor(data.toDto(),{clone:!0,validate:!1}),delete this._props.data}}static assertValidMessage(message){const error=new entityValidationError.A("This is not a valid OpenPGP armored message");if(!message||"string"!=typeof message||""===message)throw error.addError("data","empty","The OpenPGP armored message should not be empty."),error;if(!message.match(/-----BEGIN PGP MESSAGE-----/))throw error.addError("data","begin","The OpenPGP armored message should contain a start delimiter."),error;if(!message.match(/-----END PGP MESSAGE-----/))throw error.addError("data","end","The OpenPGP armored message should contain an end delimiter."),error}toDto(contain={}){const result=Object.assign({},this._props);return contain?(this._data&&contain.data&&(result.data=this._data.toDto()),result):result}static get ALL_CONTAIN_OPTIONS(){return{data:!0}}}const secretEntity=SecretEntity;class SecretsCollection extends entityV2Collection.A{get entityClass(){return secretEntity}constructor(dtos=[],options={}){super(dtos,options)}static getSchema(){return{type:"array",items:secretEntity.getSchema()}}validateBuildRules(item,options){this.assertNotExist("id",item._props.id,{haystackSet:options?.uniqueIdsSetCache}),this.assertUniqueResourceIdUserId(item,{haystackSet:options?.uniqueResourceIdUserIdSetCache})}hasSecretsDataDecrypted(){return this._items.every(secret=>secret.isDataDecrypted)}hasSecretsDataEncrypted(){return this._items.every(secret=>!secret.isDataDecrypted)}filterOutSecretDataEncrypted(){this.filterByCallback(secret=>secret.isDataDecrypted)}assertUniqueResourceIdUserId(secret,options){if(!secret.userId||!secret.resourceId)return;let haystackSet=options?.haystackSet;haystackSet||(haystackSet=new Set(this.items.map(item=>`${item.resourceId}:${item.userId}`)));const resourceIdUserIdKey=`${secret.resourceId}:${secret.userId}`;if(haystackSet.has(resourceIdUserIdKey)){const error=new entityValidationError.A,message=`The collection already includes an element that has a couple resource_id:user_id (${resourceIdUserIdKey}) with an identical value.`;throw error.addError("resource_id:user_id","unique",message),error}}pushMany(data,entityOptions={},options={}){const uniqueIdsSetCache=new Set(this.extract("id")),uniqueResourceIdUserIdSetCache=new Set(this.items.map(item=>`${item.id}:${item.userId}`));options={onItemPushed:item=>{uniqueIdsSetCache.add(item.id),uniqueResourceIdUserIdSetCache.add(`${item.resourceId}:${item.userId}`)},validateBuildRules:{...options?.validateBuildRules,uniqueIdsSetCache,uniqueResourceIdUserIdSetCache},...options},super.pushMany(data,entityOptions,options)}toDto(contains={}){return this._items.map(entity=>entity.toDto(contains))}}const secretsCollection=SecretsCollection;var userEntity=__webpack_require__("./src/shared/models/entity/user/userEntity.js");class SecretRevisionEntity extends entityV2.A{static getSchema(){return{type:"object",required:["id","resource_id","resource_type_id","created","created_by","modified","modified_by"],properties:{id:{type:"string",format:"uuid"},resource_id:{type:"string",format:"uuid"},resource_type_id:{type:"string",format:"uuid"},created:{type:"string",format:"date-time"},created_by:{type:"string",format:"uuid"},modified:{type:"string",format:"date-time"},modified_by:{type:"string",format:"uuid"},deleted:{type:"string",format:"date-time",nullable:!0},secrets:secretsCollection.getSchema(),creator:userEntity.A.getSchema()}}}static get associations(){return{creator:userEntity.A,secrets:secretsCollection}}get id(){return this._props.id}get resourceId(){return this._props.resource_id}get resourceTypeId(){return this._props.resource_type_id}get created(){return this._props.created}get createdBy(){return this._props.created_by}get modified(){return this._props.modified}get modifiedBy(){return this._props.modified_by}get deleted(){return this._props.deleted||null}get creator(){return this._creator||null}get secrets(){return this._secrets||null}toDto(contain=SecretRevisionEntity.ALL_CONTAIN_OPTIONS){const result=Object.assign({},this._props);return contain?(this._creator&&contain.creator&&(result.creator=this._creator.toDto(userEntity.A.ALL_CONTAIN_OPTIONS)),this._secrets&&contain.secrets&&(result.secrets=this._secrets.toDto(secretEntity.ALL_CONTAIN_OPTIONS)),result):result}static get ALL_CONTAIN_OPTIONS(){return{creator:!0,secrets:!0}}}const secretRevisionEntity=SecretRevisionEntity;class ResourceSecretRevisionsCollection extends entityV2Collection.A{get entityClass(){return secretRevisionEntity}constructor(dtos=[],options={}){super(dtos,options)}static getSchema(){return{type:"array",items:secretRevisionEntity.getSchema()}}validateBuildRules(item,options={}){this.assertNotExist("id",item._props.id,{haystackSet:options?.uniqueIdsSetCache}),this.assertSameResourceId(item)}assertSameResourceId(secretRevision){if(!this.items.length)return;const collectionResourceId=this.items[0].resourceId;if(secretRevision.resourceId!==collectionResourceId){const error=new entityValidationError.A,message=`The collection has different resource id: ${collectionResourceId} != ${secretRevision.resourceId}.`;throw error.addError("resource_id","different_resource_id",message),error}}sortByModified(){this._items.sort((secretRevisionEntityA,secretRevisionEntityB)=>secretRevisionEntityB.modified>secretRevisionEntityA.modified?1:-1)}toDto(contains=secretRevisionEntity.ALL_CONTAIN_OPTIONS){return this._items.map(entity=>entity.toDto(contains))}pushMany(data,entityOptions={},options={}){const uniqueIdsSetCache=new Set(this.extract("id"));options={onItemPushed:item=>{uniqueIdsSetCache.add(item._props.id)},validateBuildRules:{...options?.validateBuildRules,uniqueIdsSetCache},...options},super.pushMany(data,entityOptions,options)}filterOutItemsHavingSecretDataEncrypted(){this.filterByCallback(resourceRevision=>!resourceRevision.secrets?.hasSecretsDataEncrypted())}}const resourceSecretRevisionsCollection=ResourceSecretRevisionsCollection;class SecretRevisionsResourceServiceWorkerService{constructor(port){this.port=port}async findAllByResourceIdForDisplay(resourceId){(0,assertString.A)(resourceId);const secretRevisionsCollection=await this.port.request("passbolt.secret-revisions.find-all-by-resource-id-for-display",resourceId);return new resourceSecretRevisionsCollection(secretRevisionsCollection,{validate:!1})}}var dateUtils=__webpack_require__("./src/shared/utils/dateUtils.js"),UserAvatar=__webpack_require__("./src/react-extension/components/Common/Avatar/UserAvatar.js"),TooltipMessageFingerprintLoading=__webpack_require__("./src/react-extension/components/Common/Tooltip/TooltipMessageFingerprintLoading.js"),fingerprint=__webpack_require__("./src/img/svg/fingerprint.svg"),Fingerprint=__webpack_require__("./src/react-extension/components/Common/Fingerprint/Fingerprint.js");class DisplayCreatorSecretRevision extends react.Component{constructor(props){super(props),this.state=this.defaultState,this.bindCallbacks()}get defaultState(){return{tooltipFingerprintMessage:null}}bindCallbacks(){this.handleSelectSecretRevision=this.handleSelectSecretRevision.bind(this)}handleSelectSecretRevision(event){event.preventDefault(),this.props.onSelectSecretRevision&&this.props.onSelectSecretRevision(this.props.secretRevision.id)}async onTooltipFingerprintMouseHover(userId){if(this.state.tooltipFingerprintMessage)return;let tooltipFingerprintMessage;try{const gpgkey=await this.props.context.port.request("passbolt.keyring.get-public-key-info-by-user",userId);tooltipFingerprintMessage=react.createElement(Fingerprint.A,{fingerprint:gpgkey.fingerprint})}catch(error){console.error(error),tooltipFingerprintMessage=react.createElement("p",null,error.message)}this.setState({tooltipFingerprintMessage})}get creator(){return this.props.secretRevision.creator?this.props.secretRevision.creator:new userEntity.A({username:"Unknown user",profile:{first_name:"Unknown",last_name:"user"},status:userEntity.H.DELETED})}get translate(){return this.props.t}render(){return react.createElement("button",{type:"button",className:"no-border",disabled:this.props.disabled,onClick:this.handleSelectSecretRevision},react.createElement("div",{className:"creator"},react.createElement(UserAvatar.A,{user:this.creator.toDto(userEntity.A.ALL_CONTAIN_OPTIONS),baseUrl:this.props.context.userSettings.getTrustedDomain()}),react.createElement("div",{className:"profile"},react.createElement("div",{className:"name"},react.createElement("span",{className:"ellipsis"},this.creator.getUserFormattedName(this.translate)),this.creator?.id&&react.createElement(TooltipPortal.A,{message:this.state.tooltipFingerprintMessage||react.createElement(TooltipMessageFingerprintLoading.A,null),onMouseHover:()=>this.onTooltipFingerprintMouseHover(this.creator?.id)},react.createElement(fingerprint.A,null))),react.createElement("div",{className:"username ellipsis"},this.creator.username))),react.createElement("div",{className:"additional-information"},this.creator.status===userEntity.H.SUSPENDED&&react.createElement("div",{className:"status suspended ellipsis"},react.createElement(es.x6,null,"Suspended")),this.creator.status===userEntity.H.DELETED&&react.createElement("div",{className:"status deleted ellipsis"},react.createElement(es.x6,null,"Deleted")),react.createElement("div",{className:"updated-date ellipsis"},react.createElement("span",null,"Edited:")," ",(0,dateUtils.kD)(this.props.secretRevision.modified,this.translate,this.props.context.locale))))}}DisplayCreatorSecretRevision.defaultProps={disabled:!0},DisplayCreatorSecretRevision.propTypes={secretRevision:prop_types_default().instanceOf(secretRevisionEntity).isRequired,disabled:prop_types_default().bool,onSelectSecretRevision:prop_types_default().func,context:prop_types_default().object,t:prop_types_default().func};const SecretHistory_DisplayCreatorSecretRevision=(0,AppContext.L)((0,es.CI)("common")(DisplayCreatorSecretRevision));DisplayCreatorSecretRevision.__docgenInfo={description:"",methods:[{name:"defaultState",docblock:"Ge the default state\n@returns {*}",modifiers:["get"],params:[],returns:{type:{name:"mixed"}},description:"Ge the default state"},{name:"bindCallbacks",docblock:"Bind callbacks methods",modifiers:[],params:[],returns:null,description:"Bind callbacks methods"},{name:"handleSelectSecretRevision",docblock:"Handle the select secret revision\n@param event",modifiers:[],params:[{name:"event",optional:!1}],returns:null,description:"Handle the select secret revision"},{name:"onTooltipFingerprintMouseHover",docblock:"Handle whenever the user passes its mouse hover the tooltip.\n@returns {Promise<JSX>}",modifiers:["async"],params:[{name:"userId",optional:!1}],returns:{type:{name:"Promise",elements:[{name:"JSX"}]}},description:"Handle whenever the user passes its mouse hover the tooltip."},{name:"creator",docblock:"Get the creator of the secret revision\nReturns a default unknown user if creator is null\n@returns {UserEntity}",modifiers:["get"],params:[],returns:{type:{name:"UserEntity"}},description:"Get the creator of the secret revision\nReturns a default unknown user if creator is null"},{name:"translate",docblock:"Get the translate function\n@returns {function(...[*]=)}",modifiers:["get"],params:[],returns:{},description:"Get the translate function"}],displayName:"DisplayCreatorSecretRevision",props:{disabled:{defaultValue:{value:"true",computed:!1},description:"",type:{name:"bool"},required:!1},secretRevision:{description:"",type:{name:"instanceOf",value:"SecretRevisionEntity"},required:!0},onSelectSecretRevision:{description:"",type:{name:"func"},required:!1},context:{description:"",type:{name:"object"},required:!1},t:{description:"",type:{name:"func"},required:!1}}};var DialogContext=__webpack_require__("./src/react-extension/contexts/DialogContext.js"),NotifyError=__webpack_require__("./src/react-extension/components/Common/Error/NotifyError/NotifyError.js");class DisplaySecretResourceHistory extends react.Component{constructor(props){super(props),this.secretRevisionsResourceServiceWorkerService=new SecretRevisionsResourceServiceWorkerService(props.context.port),this.state=this.defaultState,this.bindCallbacks()}get defaultState(){return{resourceSecretHistorySelectedId:null,isProcessing:!0,tooltipFingerprintMessage:null}}bindCallbacks(){this.handleClose=this.handleClose.bind(this),this.onSelectSecretRevision=this.onSelectSecretRevision.bind(this),this.handleFormSubmit=this.handleFormSubmit.bind(this)}async componentDidMount(){try{this.resourceSecretRevisionsCollection=await this.secretRevisionsResourceServiceWorkerService.findAllByResourceIdForDisplay(this.props.resource.id)}catch(error){return"UserAbortsOperationError"===error?.name?(console.warn(error),void this.handleClose()):(this.props.dialogContext.open(NotifyError.A,{error}),void this.handleClose())}this.resourceSecretRevisionsCollection.sortByModified(),this.setState({resourceSecretHistorySelectedId:this.resourceSecretRevisionsCollection?.items[0]?.id,isProcessing:!1})}handleClose(){this.props.onClose()}onSelectSecretRevision(secretRevisionId){this.setState({resourceSecretHistorySelectedId:secretRevisionId})}async handleFormSubmit(event){event.preventDefault(),this.handleClose()}get secretHistoryAsJson(){const object=this.resourceSecretRevisionSelected?.secrets?.items[0]?.data;return JSON.stringify(object,null,2)}get resourceSecretRevisionSelected(){return this.state.resourceSecretHistorySelectedId?this.resourceSecretRevisionsCollection?.getFirst("id",this.state.resourceSecretHistorySelectedId):null}isResourceSecretRevisionSelected(id){return this.state.resourceSecretHistorySelectedId===id}hasNoRevisionsAccess(secrets){return secrets&&0===secrets.length}get translate(){return this.props.t}render(){return react.createElement(DialogWrapper.A,{title:this.translate("Secret history"),subtitle:this.props.resource.metadata.name,className:"resource-secret-history",disabled:this.state.isProcessing,onClose:this.handleClose},react.createElement("div",{className:"left-sidebar"},react.createElement("div",{className:"sidebar-content-sections"},this.resourceSecretRevisionsCollection?.items.map(resourceSecretRevision=>react.createElement("div",{className:`section-content ${this.isResourceSecretRevisionSelected(resourceSecretRevision.id)?"selected":""} ${this.hasNoRevisionsAccess(resourceSecretRevision.secrets)?"disabled":""}`,key:resourceSecretRevision.id},this.hasNoRevisionsAccess(resourceSecretRevision.secrets)&&react.createElement(TooltipPortal.A,{message:react.createElement(es.x6,null,"You cannot access revisions created before the resource was shared with you.")},react.createElement(SecretHistory_DisplayCreatorSecretRevision,{disabled:!0,secretRevision:resourceSecretRevision})),!this.hasNoRevisionsAccess(resourceSecretRevision.secrets)&&react.createElement(SecretHistory_DisplayCreatorSecretRevision,{disabled:this.state.isProcessing,secretRevision:resourceSecretRevision,onSelectSecretRevision:this.onSelectSecretRevision}))))),react.createElement("form",{onSubmit:this.handleFormSubmit,className:"grid-and-footer",noValidate:!0},react.createElement("div",{className:"grid"},react.createElement("div",{className:"resource-secret-history-workspace"},react.createElement("div",{className:"title"},react.createElement("h2",null,react.createElement(es.x6,null,"Secret revision"),react.createElement("span",{className:"subtitle"},(0,dateUtils.kD)(this.resourceSecretRevisionSelected?.modified,this.props.t,this.props.context.locale)))),react.createElement("div",{className:"content"},react.createElement("div",{className:"secret-history-fields"},this.resourceSecretRevisionsCollection?.length>0&&react.createElement("pre",null,react.createElement("code",{className:"json-object"},this.secretHistoryAsJson)),0===this.resourceSecretRevisionsCollection?.length&&react.createElement("p",{className:"empty-content"},react.createElement(es.x6,null,"There is no revision")))))),react.createElement("div",{className:"submit-wrapper"},react.createElement(FormSubmitButton.A,{value:this.translate("Close"),disabled:this.state.isProcessing,processing:this.state.isProcessing}))))}}DisplaySecretResourceHistory.propTypes={onClose:prop_types_default().func,resource:prop_types_default().object,dialogContext:prop_types_default().object,context:prop_types_default().object,t:prop_types_default().func};const DisplayResourceSecretHistory=(0,AppContext.L)((0,DialogContext.z9)((0,es.CI)("common")(DisplaySecretResourceHistory)));DisplaySecretResourceHistory.__docgenInfo={description:"",methods:[{name:"defaultState",docblock:"Ge the default state\n@returns {*}",modifiers:["get"],params:[],returns:{type:{name:"mixed"}},description:"Ge the default state"},{name:"bindCallbacks",docblock:"Bind callbacks methods",modifiers:[],params:[],returns:null,description:"Bind callbacks methods"},{name:"handleClose",docblock:"Handle close",modifiers:[],params:[],returns:null,description:"Handle close"},{name:"onSelectSecretRevision",docblock:"Set the state for the resource form selected\n@param {string} secretRevisionId The secret revision id",modifiers:[],params:[{name:"secretRevisionId",description:"The secret revision id",type:{name:"string"},optional:!1}],returns:null,description:"Set the state for the resource form selected"},{name:"handleFormSubmit",docblock:"Handle form submission that can be trigger when hitting `enter`\n@param {Event} event The html event triggering the form submit.",modifiers:["async"],params:[{name:"event",description:"The html event triggering the form submit.",type:{name:"Event"},optional:!1}],returns:null,description:"Handle form submission that can be trigger when hitting `enter`"},{name:"secretHistoryAsJson",docblock:"Get the secret history in JSON format\n@return {string | React.JSX.Element}",modifiers:["get"],params:[],returns:{type:{name:"union",elements:[{name:"string"},{name:"React.JSX.Element"}]}},description:"Get the secret history in JSON format"},{name:"resourceSecretRevisionSelected",docblock:"Get the resource secret revision selected\n@return {SecretRevisionEntity | null}",modifiers:["get"],params:[],returns:{type:{name:"union",elements:[{name:"SecretRevisionEntity"}]}},description:"Get the resource secret revision selected"},{name:"isResourceSecretRevisionSelected",docblock:"Is resource secret revision selected\n@param id\n@return {boolean}",modifiers:[],params:[{name:"id",optional:!1}],returns:{type:{name:"boolean"}},description:"Is resource secret revision selected"},{name:"hasNoRevisionsAccess",docblock:"Has no resource secret revision access\n@param secrets\n@return {boolean}",modifiers:[],params:[{name:"secrets",optional:!1}],returns:{type:{name:"boolean"}},description:"Has no resource secret revision access"},{name:"translate",docblock:"Get the translate function\n@returns {function(...[*]=)}",modifiers:["get"],params:[],returns:{},description:"Get the translate function"}],displayName:"DisplaySecretResourceHistory",props:{onClose:{description:"",type:{name:"func"},required:!1},resource:{description:"",type:{name:"object"},required:!1},dialogContext:{description:"",type:{name:"object"},required:!1},context:{description:"",type:{name:"object"},required:!1},t:{description:"",type:{name:"func"},required:!1}}}},"./src/shared/models/entity/secret/secretEntity.test.data.js":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{n:()=>readSecret});var uuid__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__("./node_modules/uuid/dist/esm-browser/v4.js");const readSecret=(data={})=>({id:(0,uuid__WEBPACK_IMPORTED_MODULE_0__.A)(),user_id:(0,uuid__WEBPACK_IMPORTED_MODULE_0__.A)(),resource_id:(0,uuid__WEBPACK_IMPORTED_MODULE_0__.A)(),secret_revision_id:(0,uuid__WEBPACK_IMPORTED_MODULE_0__.A)(),data:"-----BEGIN PGP MESSAGE----- -----END PGP MESSAGE-----",created:"2022-03-04T13:59:11+00:00",created_by:(0,uuid__WEBPACK_IMPORTED_MODULE_0__.A)(),modified:"2022-03-04T13:59:11+00:00",modified_by:(0,uuid__WEBPACK_IMPORTED_MODULE_0__.A)(),...data})}}]);